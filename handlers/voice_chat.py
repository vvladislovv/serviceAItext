from aiogram import Router, F, types
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from Messages.settingsmsg import new_message, update_message
from Messages.utils import escape_markdown
from services.logging import logs_bot
from services.openai_services import OpenAIService
from Messages.inlinebutton import tts_quality_menu
from Messages.settingsmsg import answer_voice
import os

router = Router(name=__name__)
openai_service = OpenAIService()

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è FSM
class TTSStates(StatesGroup):
    waiting_for_quality = State()  # –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (HD –∏–ª–∏ –æ–±—ã—á–Ω–æ–µ)
    waiting_for_voice = State()    # –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–∞
    waiting_for_text = State()     # –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è

# –ì–æ–ª–æ—Å–∞ –¥–ª—è TTS
TTS_VOICES = {
    "alloy": "Alloy (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π)",
    "echo": "Echo (–º—É–∂—Å–∫–æ–π)",
    "fable": "Fable (–±—Ä–∏—Ç–∞–Ω—Å–∫–∏–π)",
    "onyx": "Onyx (–≥–ª—É–±–æ–∫–∏–π)",
    "nova": "Nova (–∂–µ–Ω—Å–∫–∏–π)",
    "shimmer": "Shimmer (–º–µ–ª–æ–¥–∏—á–Ω—ã–π)"
}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—á–∏"
@router.callback_query(F.data == "TSSGenerat")
async def tts_start(call: CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—á–∏"""
    try:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—á–µ—Å—Ç–≤–∞
        
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –∫–∞—á–µ—Å—Ç–≤–∞
        await update_message(
            call.message,
            "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—á–∏:",
            await tts_quality_menu()
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –∫–∞—á–µ—Å—Ç–≤–∞
        await state.set_state(TTSStates.waiting_for_quality)
        
    except Exception as e:
        await logs_bot("error", f"Error in tts_start: {str(e)}")
        await call.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ—á–∏")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—á–µ—Å—Ç–≤–∞
@router.callback_query(TTSStates.waiting_for_quality, F.data.startswith("tts_quality_"))
async def tts_select_quality(call: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞—Ç—å –≥–æ–ª–æ—Å"""
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
        quality = "tts_hd" if call.data == "tts_quality_hd" else "tts"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        await state.update_data(quality=quality)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–∞
        keyboard = []
        row = []
        
        for voice_id, voice_name in TTS_VOICES.items():
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–ª–æ—Å–∞
            button = types.InlineKeyboardButton(
                text=voice_name,
                callback_data=f"tts_voice_{voice_id}"
            )
            
            row.append(button)
            if len(row) == 2:  # –ü–æ –¥–≤–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥—É
                keyboard.append(row)
                row = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        if row:
            keyboard.append(row)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
        keyboard.append([
            types.InlineKeyboardButton(text="‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –∫–∞—á–µ—Å—Ç–≤–∞", callback_data="TSSGenerat")
        ])
        
        markup = types.InlineKeyboardMarkup(inline_keyboard=keyboard)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –≥–æ–ª–æ—Å–∞
        await update_message(
            call.message,
            f"–í—ã–±—Ä–∞–Ω–æ {'HD' if quality == 'tts_hd' else '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ'} –∫–∞—á–µ—Å—Ç–≤–æ\\. –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å:",
            markup
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–∞
        await state.set_state(TTSStates.waiting_for_voice)
        
    except Exception as e:
        await logs_bot("error", f"Error in tts_select_quality: {str(e)}")
        await call.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—á–µ—Å—Ç–≤–∞")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–∞
@router.callback_query(TTSStates.waiting_for_voice, F.data.startswith("tts_voice_"))
async def tts_select_voice(call: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ–ª–æ—Å–∞ –∏ –∑–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è"""
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –≥–æ–ª–æ—Å–∞ –∏–∑ callback_data
        voice_id = call.data.replace("tts_voice_", "")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ–ª–æ—Å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        await state.update_data(voice=voice_id)
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–∞—á–µ—Å—Ç–≤–µ
        data = await state.get_data()
        quality = data.get("quality", "tts")
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø—Ä–∏–º–µ—Ä–æ–º –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–º
        keyboard = [
            [
                types.InlineKeyboardButton(
                    text="üîä –ü—Ä–∏–º–µ—Ä: '–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!'", 
                    callback_data="tts_example"
                )
            ],
            [
                types.InlineKeyboardButton(
                    text="‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –≥–æ–ª–æ—Å–∞", 
                    callback_data=f"tts_quality_{'hd' if quality == 'tts_hd' else 'standard'}"
                )
            ]
        ]
        markup = types.InlineKeyboardMarkup(inline_keyboard=keyboard)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç
        voice_name = TTS_VOICES.get(voice_id, voice_id)
        await update_message(
            call.message,
            f"–í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å: *{escape_markdown(voice_name)}*\\.\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –æ–∑–≤—É—á–∏—Ç—å, –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –ø—Ä–∏–º–µ—Ä–∞\\.",
            markup
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
        await state.set_state(TTSStates.waiting_for_text)
        
    except Exception as e:
        await logs_bot("error", f"Error in tts_select_voice: {str(e)}")
        await call.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≥–æ–ª–æ—Å–∞")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ—Ä–∞
@router.callback_query(TTSStates.waiting_for_text, F.data == "tts_example")
async def tts_example(call: CallbackQuery, state: FSMContext):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data = await state.get_data()
        quality = data.get("quality", "tts")
        voice = data.get("voice", "alloy")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        await call.answer("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–∞...")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await generate_voice_message(
            call.message, 
            "–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!", 
            voice, 
            quality
        )
        
    except Exception as e:
        await logs_bot("error", f"Error in tts_example: {str(e)}")
        await call.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ—Ä–∞")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
@router.message(TTSStates.waiting_for_text)
async def tts_process_text(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        data = await state.get_data()
        quality = data.get("quality", "tts")
        voice = data.get("voice", "alloy")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        if not message.text or len(message.text.strip()) == 0:
            await new_message(
                message, 
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è\\."
            )
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
        if len(message.text) > 1000:
            await new_message(
                message, 
                "–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π\\. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 1000 —Å–∏–º–≤–æ–ª–æ–≤\\."
            )
            return
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await generate_voice_message(
            message, 
            message.text, 
            voice, 
            quality
        )
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await state.clear()
        
    except Exception as e:
        await logs_bot("error", f"Error in tts_process_text: {str(e)}")
        await new_message(
            message, 
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\\."
        )

async def generate_voice_message(message: Message, text: str, voice: str, model: str = "tts"):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI API
    
    Args:
        message: –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        text: –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
        voice: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≥–æ–ª–æ—Å–∞ (alloy, echo, fable, onyx, nova, shimmer)
        model: –ú–æ–¥–µ–ª—å TTS (tts –∏–ª–∏ tts_hd)
    """
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
        await message.bot.send_chat_action(
            chat_id=message.chat.id, 
            action="record_voice"
        )
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ProxyAPI
        audio_path = await openai_service.text_to_speech(text, voice, model)
        
        if not audio_path or not os.path.exists(audio_path):
            await logs_bot("error", f"Audio file not found: {audio_path}")
            await new_message(
                message, 
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\\. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ\\."
            )
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º FSInputFile –≤–º–µ—Å—Ç–æ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞ –Ω–∞–ø—Ä—è–º—É—é
            from aiogram.types import FSInputFile
            voice_file = FSInputFile(audio_path)
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –ø–æ–¥–ø–∏—Å–∏
            voice_name = TTS_VOICES.get(voice, voice)
            caption = f"üîä –ì–æ–ª–æ—Å: {voice_name}"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Markdown
            await answer_voice(message, voice_file, caption)
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            try:
                os.remove(audio_path)
            except Exception as e:
                await logs_bot("warning", f"Failed to remove temp file {audio_path}: {e}")
        except Exception as send_error:
            await logs_bot("error", f"Error sending voice message: {send_error}")
            await new_message(
                message, 
                "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\\."
            )
        
    except Exception as e:
        await logs_bot("error", f"Error in generate_voice_message: {str(e)}")
        await new_message(
            message, 
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\\."
        )
